import numpy as np
import pandas as pd
import plotly.graph_objects as go
import plotly.io as pio

# Define the parse_eps function (make sure to implement this according to your EPS file format)
def parse_eps(eps_file):
    # Dummy implementation, replace with actual parsing logic
    # Assuming it returns a list of tuples (i, j, prob)
    return [(i, i+1, np.random.rand()) for i in range(20)]

# Assuming parse_eps is defined and you have two EPS files for WT and mutant
wt_eps_file = 'wild-type.eps'
mutant_eps_file = 'mutation1.eps'

# Load base-pair probabilities for WT and mutant
wt_pairs = parse_eps(wt_eps_file)
mutant_pairs = parse_eps(mutant_eps_file)

# Create matrices for WT and mutant base-pair probabilities
sequence_length = max(max(i, j) for i, j, _ in wt_pairs + mutant_pairs) + 1
wt_bp_prob_matrix = np.zeros((sequence_length, sequence_length))
mutant_bp_prob_matrix = np.zeros((sequence_length, sequence_length))

for i, j, prob in wt_pairs:
    wt_bp_prob_matrix[i, j] = prob
for i, j, prob in mutant_pairs:
    mutant_bp_prob_matrix[i, j] = prob

# Compute the difference matrix
difference_matrix = np.abs(wt_bp_prob_matrix - mutant_bp_prob_matrix)

# Prepare data for Plotly
wt_significant_pairs = [(i, j, prob) for i, j, prob in wt_pairs if prob > 0.5]  # replace threshold with your criteria
mutant_significant_pairs = [(i, j, prob) for i, j, prob in mutant_pairs if prob > 0.5]  # replace threshold with your criteria

wt_df = pd.DataFrame(wt_significant_pairs, columns=['x', 'y', 'prob'])
mutant_df = pd.DataFrame(mutant_significant_pairs, columns=['x', 'y', 'prob'])

# Create an interactive scatter plot
fig = go.Figure()

fig.add_trace(go.Scatter(
    x=wt_df['x'], y=wt_df['y'], mode='markers',
    marker=dict(size=5, color=wt_df['prob'], colorscale='Blues', showscale=True),
    name='WT'
))

fig.add_trace(go.Scatter(
    x=mutant_df['x'], y=mutant_df['y'], mode='markers',
    marker=dict(size=5, color=mutant_df['prob'], colorscale='Reds', showscale=True),
    name='Mutant'
))

fig.update_layout(
    title='Significant Base Pairs (WT vs. Mutant)',
    xaxis_title='Base Position',
    yaxis_title='Base Position'
)

# Save the plot as an HTML file
pio.write_html(fig, file='plotpy.html', auto_open=False)
